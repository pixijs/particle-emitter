{"version":3,"sources":["../src/Loader.js"],"names":["async","MAX_PROGRESS","rgxExtractUrlHash","Loader","baseUrl","concurrency","progress","loading","defaultQueryString","_beforeMiddleware","_afterMiddleware","_resourcesParsing","_boundLoadResource","r","d","_loadResource","_queue","queue","pause","resources","onProgress","Signal","onError","onLoad","onStart","onComplete","i","_defaultBeforeMiddleware","length","pre","_defaultAfterMiddleware","use","add","name","url","options","cb","Array","isArray","callback","key","Error","parentResource","_prepareUrl","Resource","onAfterMiddleware","once","parent","incompleteChildren","children","isComplete","push","fullChunk","progressChunk","eachChunk","fn","reset","kill","k","res","_onLoadBinding","detach","isLoading","abort","load","idle","_onStart","_onComplete","numTasks","_tasks","chunk","data","resume","parsedUrl","strictMode","result","protocol","path","indexOf","lastIndexOf","charAt","hash","exec","substr","resource","dequeue","_dequeue","eachSeries","next","call","_onLoad","dispatch","Math","min","error","splice","LoaderPreStatic","LoaderUseStatic"],"mappings":"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","file":"Loader.js","sourcesContent":["import Signal from 'mini-signals';\nimport parseUri from 'parse-uri';\nimport * as async from './async';\nimport { Resource } from './Resource';\n\n// some constants\nconst MAX_PROGRESS = 100;\nconst rgxExtractUrlHash = /(#[\\w-]+)?$/;\n\n/**\n * Manages the state and loading of multiple resources to load.\n *\n * @class\n */\nexport class Loader {\n    /**\n     * @param {string} [baseUrl=''] - The base url for all resources loaded by this loader.\n     * @param {number} [concurrency=10] - The number of resources to load concurrently.\n     */\n    constructor(baseUrl = '', concurrency = 10) {\n        /**\n         * The base url for all resources loaded by this loader.\n         *\n         * @member {string}\n         */\n        this.baseUrl = baseUrl;\n\n        /**\n         * The progress percent of the loader going through the queue.\n         *\n         * @member {number}\n         */\n        this.progress = 0;\n\n        /**\n         * Loading state of the loader, true if it is currently loading resources.\n         *\n         * @member {boolean}\n         */\n        this.loading = false;\n\n        /**\n         * A querystring to append to every URL added to the loader.\n         *\n         * This should be a valid query string *without* the question-mark (`?`). The loader will\n         * also *not* escape values for you. Make sure to escape your parameters with\n         * [`encodeURIComponent`](https://mdn.io/encodeURIComponent) before assigning this property.\n         *\n         * @example\n         * const loader = new Loader();\n         *\n         * loader.defaultQueryString = 'user=me&password=secret';\n         *\n         * // This will request 'image.png?user=me&password=secret'\n         * loader.add('image.png').load();\n         *\n         * loader.reset();\n         *\n         * // This will request 'image.png?v=1&user=me&password=secret'\n         * loader.add('iamge.png?v=1').load();\n         *\n         * @member {string}\n         */\n        this.defaultQueryString = '';\n\n        /**\n         * The middleware to run before loading each resource.\n         *\n         * @private\n         * @member {function[]}\n         */\n        this._beforeMiddleware = [];\n\n        /**\n         * The middleware to run after loading each resource.\n         *\n         * @private\n         * @member {function[]}\n         */\n        this._afterMiddleware = [];\n\n        /**\n         * The tracks the resources we are currently completing parsing for.\n         *\n         * @private\n         * @member {Resource[]}\n         */\n        this._resourcesParsing = [];\n\n        /**\n         * The `_loadResource` function bound with this object context.\n         *\n         * @private\n         * @member {function}\n         * @param {Resource} r - The resource to load\n         * @param {Function} d - The dequeue function\n         * @return {undefined}\n         */\n        this._boundLoadResource = (r, d) => this._loadResource(r, d);\n\n        /**\n         * The resources waiting to be loaded.\n         *\n         * @private\n         * @member {Resource[]}\n         */\n        this._queue = async.queue(this._boundLoadResource, concurrency);\n\n        this._queue.pause();\n\n        /**\n         * All the resources for this loader keyed by name.\n         *\n         * @member {object<string, Resource>}\n         */\n        this.resources = {};\n\n        /**\n         * Dispatched once per loaded or errored resource.\n         *\n         * The callback looks like {@link Loader.OnProgressSignal}.\n         *\n         * @member {Signal}\n         */\n        this.onProgress = new Signal();\n\n        /**\n         * Dispatched once per errored resource.\n         *\n         * The callback looks like {@link Loader.OnErrorSignal}.\n         *\n         * @member {Signal}\n         */\n        this.onError = new Signal();\n\n        /**\n         * Dispatched once per loaded resource.\n         *\n         * The callback looks like {@link Loader.OnLoadSignal}.\n         *\n         * @member {Signal}\n         */\n        this.onLoad = new Signal();\n\n        /**\n         * Dispatched when the loader begins to process the queue.\n         *\n         * The callback looks like {@link Loader.OnStartSignal}.\n         *\n         * @member {Signal}\n         */\n        this.onStart = new Signal();\n\n        /**\n         * Dispatched when the queued resources all load.\n         *\n         * The callback looks like {@link Loader.OnCompleteSignal}.\n         *\n         * @member {Signal}\n         */\n        this.onComplete = new Signal();\n\n        // Add default before middleware\n        for (let i = 0; i < Loader._defaultBeforeMiddleware.length; ++i) {\n            this.pre(Loader._defaultBeforeMiddleware[i]);\n        }\n\n        // Add default after middleware\n        for (let i = 0; i < Loader._defaultAfterMiddleware.length; ++i) {\n            this.use(Loader._defaultAfterMiddleware[i]);\n        }\n    }\n\n    /**\n     * When the progress changes the loader and resource are disaptched.\n     *\n     * @memberof Loader\n     * @callback OnProgressSignal\n     * @param {Loader} loader - The loader the progress is advancing on.\n     * @param {Resource} resource - The resource that has completed or failed to cause the progress to advance.\n     */\n\n    /**\n     * When an error occurrs the loader and resource are disaptched.\n     *\n     * @memberof Loader\n     * @callback OnErrorSignal\n     * @param {Loader} loader - The loader the error happened in.\n     * @param {Resource} resource - The resource that caused the error.\n     */\n\n    /**\n     * When a load completes the loader and resource are disaptched.\n     *\n     * @memberof Loader\n     * @callback OnLoadSignal\n     * @param {Loader} loader - The loader that laoded the resource.\n     * @param {Resource} resource - The resource that has completed loading.\n     */\n\n    /**\n     * When the loader starts loading resources it dispatches this callback.\n     *\n     * @memberof Loader\n     * @callback OnStartSignal\n     * @param {Loader} loader - The loader that has started loading resources.\n     */\n\n    /**\n     * When the loader completes loading resources it dispatches this callback.\n     *\n     * @memberof Loader\n     * @callback OnCompleteSignal\n     * @param {Loader} loader - The loader that has finished loading resources.\n     */\n\n    /**\n     * Options for a call to `.add()`.\n     *\n     * @see Loader#add\n     *\n     * @typedef {object} IAddOptions\n     * @property {string} [name] - The name of the resource to load, if not passed the url is used.\n     * @property {string} [key] - Alias for `name`.\n     * @property {string} [url] - The url for this resource, relative to the baseUrl of this loader.\n     * @property {string|boolean} [crossOrigin] - Is this request cross-origin? Default is to\n     *      determine automatically.\n     * @property {number} [timeout=0] - A timeout in milliseconds for the load. If the load takes\n     *      longer than this time it is cancelled and the load is considered a failure. If this value is\n     *      set to `0` then there is no explicit timeout.\n     * @property {Resource.LOAD_TYPE} [loadType=Resource.LOAD_TYPE.XHR] - How should this resource\n     *      be loaded?\n     * @property {Resource.XHR_RESPONSE_TYPE} [xhrType=Resource.XHR_RESPONSE_TYPE.DEFAULT] - How\n     *      should the data being loaded be interpreted when using XHR?\n     * @property {Loader.OnCompleteSignal} [onComplete] - Callback to add an an onComplete signal istener.\n     * @property {Loader.OnCompleteSignal} [callback] - Alias for `onComplete`.\n     * @property {Resource.IMetadata} [metadata] - Extra configuration for middleware and the Resource object.\n     */\n\n    /**\n     * Adds a resource (or multiple resources) to the loader queue.\n     *\n     * This function can take a wide variety of different parameters. The only thing that is always\n     * required the url to load. All the following will work:\n     *\n     * ```js\n     * loader\n     *     // normal param syntax\n     *     .add('key', 'http://...', function () {})\n     *     .add('http://...', function () {})\n     *     .add('http://...')\n     *\n     *     // object syntax\n     *     .add({\n     *         name: 'key2',\n     *         url: 'http://...'\n     *     }, function () {})\n     *     .add({\n     *         url: 'http://...'\n     *     }, function () {})\n     *     .add({\n     *         name: 'key3',\n     *         url: 'http://...'\n     *         onComplete: function () {}\n     *     })\n     *     .add({\n     *         url: 'https://...',\n     *         onComplete: function () {},\n     *         crossOrigin: true\n     *     })\n     *\n     *     // you can also pass an array of objects or urls or both\n     *     .add([\n     *         { name: 'key4', url: 'http://...', onComplete: function () {} },\n     *         { url: 'http://...', onComplete: function () {} },\n     *         'http://...'\n     *     ])\n     *\n     *     // and you can use both params and options\n     *     .add('key', 'http://...', { crossOrigin: true }, function () {})\n     *     .add('http://...', { crossOrigin: true }, function () {});\n     * ```\n     *\n     * @param {string|IAddOptions} [name] - The name of the resource to load, if not passed the url is used.\n     * @param {string} [url] - The url for this resource, relative to the baseUrl of this loader.\n     * @param {IAddOptions} [options] - The options for the load.\n     * @param {Loader.OnCompleteSignal} [cb] - Function to call when this specific resource completes loading.\n     * @return {this} Returns itself.\n     */\n    add(name, url, options, cb) {\n        // special case of an array of objects or urls\n        if (Array.isArray(name)) {\n            for (let i = 0; i < name.length; ++i) {\n                this.add(name[i]);\n            }\n\n            return this;\n        }\n\n        // if an object is passed instead of params\n        if (typeof name === 'object') {\n            cb = url || name.callback || name.onComplete;\n            options = name;\n            url = name.url;\n            name = name.name || name.key || name.url;\n        }\n\n        // case where no name is passed shift all args over by one.\n        if (typeof url !== 'string') {\n            cb = options;\n            options = url;\n            url = name;\n        }\n\n        // now that we shifted make sure we have a proper url.\n        if (typeof url !== 'string') {\n            throw new Error('No url passed to add resource to loader.');\n        }\n\n        // options are optional so people might pass a function and no options\n        if (typeof options === 'function') {\n            cb = options;\n            options = null;\n        }\n\n        // if loading already you can only add resources that have a parent.\n        if (this.loading && (!options || !options.parentResource)) {\n            throw new Error('Cannot add resources while the loader is running.');\n        }\n\n        // check if resource already exists.\n        if (this.resources[name]) {\n            throw new Error(`Resource named \"${name}\" already exists.`);\n        }\n\n        // add base url if this isn't an absolute url\n        url = this._prepareUrl(url);\n\n        // create the store the resource\n        this.resources[name] = new Resource(name, url, options);\n\n        if (typeof cb === 'function') {\n            this.resources[name].onAfterMiddleware.once(cb);\n        }\n\n        // if actively loading, make sure to adjust progress chunks for that parent and its children\n        if (this.loading) {\n            const parent = options.parentResource;\n            const incompleteChildren = [];\n\n            for (let i = 0; i < parent.children.length; ++i) {\n                if (!parent.children[i].isComplete) {\n                    incompleteChildren.push(parent.children[i]);\n                }\n            }\n\n            const fullChunk = parent.progressChunk * (incompleteChildren.length + 1); // +1 for parent\n            const eachChunk = fullChunk / (incompleteChildren.length + 2); // +2 for parent & new child\n\n            parent.children.push(this.resources[name]);\n            parent.progressChunk = eachChunk;\n\n            for (let i = 0; i < incompleteChildren.length; ++i) {\n                incompleteChildren[i].progressChunk = eachChunk;\n            }\n\n            this.resources[name].progressChunk = eachChunk;\n        }\n\n        // add the resource to the queue\n        this._queue.push(this.resources[name]);\n\n        return this;\n    }\n\n    /**\n     * Sets up a middleware function that will run *before* the\n     * resource is loaded.\n     *\n     * @param {function} fn - The middleware function to register.\n     * @return {this} Returns itself.\n     */\n    pre(fn) {\n        this._beforeMiddleware.push(fn);\n\n        return this;\n    }\n\n    /**\n     * Sets up a middleware function that will run *after* the\n     * resource is loaded.\n     *\n     * @param {function} fn - The middleware function to register.\n     * @return {this} Returns itself.\n     */\n    use(fn) {\n        this._afterMiddleware.push(fn);\n\n        return this;\n    }\n\n    /**\n     * Resets the queue of the loader to prepare for a new load.\n     *\n     * @return {this} Returns itself.\n     */\n    reset() {\n        this.progress = 0;\n        this.loading = false;\n\n        this._queue.kill();\n        this._queue.pause();\n\n        // abort all resource loads\n        for (const k in this.resources) {\n            const res = this.resources[k];\n\n            if (res._onLoadBinding) {\n                res._onLoadBinding.detach();\n            }\n\n            if (res.isLoading) {\n                res.abort();\n            }\n        }\n\n        this.resources = {};\n\n        return this;\n    }\n\n    /**\n     * Starts loading the queued resources.\n     *\n     * @param {function} [cb] - Optional callback that will be bound to the `complete` event.\n     * @return {this} Returns itself.\n     */\n    load(cb) {\n        // register complete callback if they pass one\n        if (typeof cb === 'function') {\n            this.onComplete.once(cb);\n        }\n\n        // if the queue has already started we are done here\n        if (this.loading) {\n            return this;\n        }\n\n        if (this._queue.idle()) {\n            this._onStart();\n            this._onComplete();\n        }\n        else {\n            // distribute progress chunks\n            const numTasks = this._queue._tasks.length;\n            const chunk = MAX_PROGRESS / numTasks;\n\n            for (let i = 0; i < this._queue._tasks.length; ++i) {\n                this._queue._tasks[i].data.progressChunk = chunk;\n            }\n\n            // notify we are starting\n            this._onStart();\n\n            // start loading\n            this._queue.resume();\n        }\n\n        return this;\n    }\n\n    /**\n     * The number of resources to load concurrently.\n     *\n     * @member {number}\n     * @default 10\n     */\n    get concurrency() {\n        return this._queue.concurrency;\n    }\n    // eslint-disable-next-line require-jsdoc\n    set concurrency(concurrency) {\n        this._queue.concurrency = concurrency;\n    }\n\n    /**\n     * Prepares a url for usage based on the configuration of this object\n     *\n     * @private\n     * @param {string} url - The url to prepare.\n     * @return {string} The prepared url.\n     */\n    _prepareUrl(url) {\n        const parsedUrl = parseUri(url, { strictMode: true });\n        let result;\n\n        // absolute url, just use it as is.\n        if (parsedUrl.protocol || !parsedUrl.path || url.indexOf('//') === 0) {\n            result = url;\n        }\n        // if baseUrl doesn't end in slash and url doesn't start with slash, then add a slash inbetween\n        else if (this.baseUrl.length\n            && this.baseUrl.lastIndexOf('/') !== this.baseUrl.length - 1\n            && url.charAt(0) !== '/'\n        ) {\n            result = `${this.baseUrl}/${url}`;\n        }\n        else {\n            result = this.baseUrl + url;\n        }\n\n        // if we need to add a default querystring, there is a bit more work\n        if (this.defaultQueryString) {\n            const hash = rgxExtractUrlHash.exec(result)[0];\n\n            result = result.substr(0, result.length - hash.length);\n\n            if (result.indexOf('?') !== -1) {\n                result += `&${this.defaultQueryString}`;\n            }\n            else {\n                result += `?${this.defaultQueryString}`;\n            }\n\n            result += hash;\n        }\n\n        return result;\n    }\n\n    /**\n     * Loads a single resource.\n     *\n     * @private\n     * @param {Resource} resource - The resource to load.\n     * @param {function} dequeue - The function to call when we need to dequeue this item.\n     */\n    _loadResource(resource, dequeue) {\n        resource._dequeue = dequeue;\n\n        // run before middleware\n        async.eachSeries(\n            this._beforeMiddleware,\n            (fn, next) => {\n                fn.call(this, resource, () => {\n                    // if the before middleware marks the resource as complete,\n                    // break and don't process any more before middleware\n                    next(resource.isComplete ? {} : null);\n                });\n            },\n            () => {\n                if (resource.isComplete) {\n                    this._onLoad(resource);\n                }\n                else {\n                    resource._onLoadBinding = resource.onComplete.once(this._onLoad, this);\n                    resource.load();\n                }\n            },\n            true\n        );\n    }\n\n    /**\n     * Called once loading has started.\n     *\n     * @private\n     */\n    _onStart() {\n        this.progress = 0;\n        this.loading = true;\n        this.onStart.dispatch(this);\n    }\n\n    /**\n     * Called once each resource has loaded.\n     *\n     * @private\n     */\n    _onComplete() {\n        this.progress = MAX_PROGRESS;\n        this.loading = false;\n        this.onComplete.dispatch(this, this.resources);\n    }\n\n    /**\n     * Called each time a resources is loaded.\n     *\n     * @private\n     * @param {Resource} resource - The resource that was loaded\n     */\n    _onLoad(resource) {\n        resource._onLoadBinding = null;\n\n        // remove this resource from the async queue, and add it to our list of resources that are being parsed\n        this._resourcesParsing.push(resource);\n        resource._dequeue();\n\n        // run all the after middleware for this resource\n        async.eachSeries(\n            this._afterMiddleware,\n            (fn, next) => {\n                fn.call(this, resource, next);\n            },\n            () => {\n                resource.onAfterMiddleware.dispatch(resource);\n\n                this.progress = Math.min(MAX_PROGRESS, this.progress + resource.progressChunk);\n                this.onProgress.dispatch(this, resource);\n\n                if (resource.error) {\n                    this.onError.dispatch(resource.error, this, resource);\n                }\n                else {\n                    this.onLoad.dispatch(this, resource);\n                }\n\n                this._resourcesParsing.splice(this._resourcesParsing.indexOf(resource), 1);\n\n                // do completion check\n                if (this._queue.idle() && this._resourcesParsing.length === 0) {\n                    this._onComplete();\n                }\n            },\n            true\n        );\n    }\n}\n\n/**\n * A default array of middleware to run before loading each resource.\n * Each of these middlewares are added to any new Loader instances when they are created.\n *\n * @private\n * @member {function[]}\n */\nLoader._defaultBeforeMiddleware = [];\n\n/**\n * A default array of middleware to run after loading each resource.\n * Each of these middlewares are added to any new Loader instances when they are created.\n *\n * @private\n * @member {function[]}\n */\nLoader._defaultAfterMiddleware = [];\n\n/**\n * Sets up a middleware function that will run *before* the\n * resource is loaded.\n *\n * @static\n * @param {function} fn - The middleware function to register.\n * @return {Loader} Returns itself.\n */\nLoader.pre = function LoaderPreStatic(fn) {\n    Loader._defaultBeforeMiddleware.push(fn);\n\n    return Loader;\n};\n\n/**\n * Sets up a middleware function that will run *after* the\n * resource is loaded.\n *\n * @static\n * @param {function} fn - The middleware function to register.\n * @return {Loader} Returns itself.\n */\nLoader.use = function LoaderUseStatic(fn) {\n    Loader._defaultAfterMiddleware.push(fn);\n\n    return Loader;\n};\n"]}